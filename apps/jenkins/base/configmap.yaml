apiVersion: v1
kind: ConfigMap
metadata:
  name: jenkins-config
data:
  jenkins.yaml: |
    jenkins:
      systemMessage: "Jenkins configured automatically by Jenkins Configuration as Code plugin"
      
      securityRealm:
        local:
          allowsSignup: false
          users:
           - id: admin
             password: ${JENKINS_ADMIN_PASSWORD:-admin123}
             
      authorizationStrategy:
        globalMatrix:
          permissions:
            - "Overall/Administer:admin"
            - "Overall/Read:authenticated"
            
      remotingSecurity:
        enabled: true
        
      nodes:
        - permanent:
            name: "built-in"
            numExecutors: 0  # Force use of dynamic agents
            
      clouds:
        - kubernetes:
            name: "kubernetes"
            serverUrl: "https://kubernetes.default"
            namespace: "default"
            jenkinsUrl: "http://jenkins:8080"
            jenkinsTunnel: "jenkins:50000"
            connectTimeout: 10
            readTimeout: 30
            containerCapStr: 50
            maxRequestsPerHostStr: 64
            retentionTimeout: 5
            podRetention: "never"
            templates:
              # Default lightweight agent
              - name: "default-agent"
                label: "default jenkins-agent"
                nodeUsageMode: NORMAL
                idleMinutes: 5
                containers:
                - name: "jnlp"
                  image: "jenkins/inbound-agent:latest-jdk17"
                  alwaysPullImage: true
                  workingDir: "/home/jenkins/agent"
                  command: ""
                  args: ""
                  ttyEnabled: false
                  resourceRequestCpu: "100m"
                  resourceRequestMemory: "256Mi"
                  resourceLimitCpu: "500m"
                  resourceLimitMemory: "1Gi"
                  
              # Docker-enabled agent for container builds
              - name: "docker-agent"
                label: "docker docker-build"
                nodeUsageMode: NORMAL
                idleMinutes: 5
                serviceAccount: "jenkins"
                containers:
                - name: "jnlp"
                  image: "jenkins/inbound-agent:latest-jdk17"
                  alwaysPullImage: true
                  workingDir: "/home/jenkins/agent"
                  resourceRequestCpu: "200m"
                  resourceRequestMemory: "512Mi"
                  resourceLimitCpu: "1000m"
                  resourceLimitMemory: "2Gi"
                - name: "docker"
                  image: "docker:dind"
                  alwaysPullImage: true
                  workingDir: "/home/jenkins/agent"
                  privileged: true
                  resourceRequestCpu: "100m"
                  resourceRequestMemory: "256Mi"
                  resourceLimitCpu: "500m"
                  resourceLimitMemory: "1Gi"
                  
              # Maven/Gradle agent for Java builds
              - name: "maven-agent"
                label: "maven gradle java"
                nodeUsageMode: NORMAL
                idleMinutes: 5
                containers:
                - name: "jnlp"
                  image: "jenkins/inbound-agent:latest-jdk17"
                  alwaysPullImage: true
                  workingDir: "/home/jenkins/agent"
                  resourceRequestCpu: "200m"
                  resourceRequestMemory: "512Mi"
                  resourceLimitCpu: "1000m"
                  resourceLimitMemory: "2Gi"
                - name: "maven"
                  image: "maven:3.9-openjdk-17"
                  alwaysPullImage: true
                  workingDir: "/home/jenkins/agent"
                  command: "sleep"
                  args: "infinity"
                  resourceRequestCpu: "100m"
                  resourceRequestMemory: "256Mi"
                  resourceLimitCpu: "500m"
                  resourceLimitMemory: "1Gi"
                  
              # Node.js agent for frontend builds
              - name: "nodejs-agent"
                label: "nodejs npm yarn frontend"
                nodeUsageMode: NORMAL
                idleMinutes: 5
                containers:
                - name: "jnlp"
                  image: "jenkins/inbound-agent:latest-jdk17"
                  alwaysPullImage: true
                  workingDir: "/home/jenkins/agent"
                  resourceRequestCpu: "100m"
                  resourceRequestMemory: "256Mi"
                  resourceLimitCpu: "500m"
                  resourceLimitMemory: "1Gi"
                - name: "nodejs"
                  image: "node:18-alpine"
                  alwaysPullImage: true
                  workingDir: "/home/jenkins/agent"
                  command: "sleep"
                  args: "infinity"
                  resourceRequestCpu: "200m"
                  resourceRequestMemory: "512Mi"
                  resourceLimitCpu: "1000m"
                  resourceLimitMemory: "2Gi"
                  
    jobs:
      - script: >
          pipelineJob('dynamic-agents-demo') {
            definition {
              cps {
                script("""
                  pipeline {
                    agent none
                    stages {
                      stage('Build Java App') {
                        agent { label 'maven' }
                        steps {
                          container('maven') {
                            sh 'mvn --version'
                            echo 'Building Java application with Maven...'
                          }
                        }
                      }
                      stage('Build Frontend') {
                        agent { label 'nodejs' }
                        steps {
                          container('nodejs') {
                            sh 'node --version'
                            sh 'npm --version'
                            echo 'Building frontend with Node.js...'
                          }
                        }
                      }
                      stage('Build Docker Image') {
                        agent { label 'docker' }
                        steps {
                          container('docker') {
                            sh 'docker --version'
                            echo 'Building Docker image...'
                          }
                        }
                      }
                      stage('Lightweight Task') {
                        agent { label 'default' }
                        steps {
                          echo 'Running on default lightweight agent'
                          sh 'echo "Agent: \$(hostname)"'
                        }
                      }
                    }
                  }
                """)
                sandbox()
              }
            }
          }
          
    unclassified:
      location:
        adminAddress: "admin@example.com"
        url: "http://jenkins:32000"
        
      globalLibraries:
        libraries:
        - name: "shared-library"
          defaultVersion: "main"
          retriever:
            modernSCM:
              scm:
                git:
                  remote: "https://github.com/your-org/jenkins-shared-library.git"
